syntax = "proto3";

package holo_store.rpc;

service HoloRpc {
  rpc PreAccept(PreAcceptRequest) returns (PreAcceptResponse);
  rpc PreAcceptBatch(PreAcceptBatchRequest) returns (PreAcceptBatchResponse);
  rpc Accept(AcceptRequest) returns (AcceptResponse);
  rpc AcceptBatch(AcceptBatchRequest) returns (AcceptBatchResponse);
  rpc Commit(CommitRequest) returns (CommitResponse);
  rpc CommitBatch(CommitBatchRequest) returns (CommitBatchResponse);
  rpc Recover(RecoverRequest) returns (RecoverResponse);
  rpc RecoverBatch(RecoverBatchRequest) returns (RecoverBatchResponse);
  rpc FetchCommand(FetchCommandRequest) returns (FetchCommandResponse);
  rpc ReportExecuted(ReportExecutedRequest) returns (ReportExecutedResponse);
  rpc LastCommitted(LastCommittedRequest) returns (LastCommittedResponse);
  rpc LastExecutedPrefix(LastExecutedPrefixRequest) returns (LastExecutedPrefixResponse);
  rpc SeedExecutedPrefix(SeedExecutedPrefixRequest) returns (SeedExecutedPrefixResponse);
  rpc Executed(ExecutedRequest) returns (ExecutedResponse);
  rpc MarkVisible(MarkVisibleRequest) returns (MarkVisibleResponse);
  rpc KvGet(KvGetRequest) returns (KvGetResponse);
  rpc KvBatchGet(KvBatchGetRequest) returns (KvBatchGetResponse);
  rpc Join(JoinRequest) returns (JoinResponse);
  rpc ClusterState(ClusterStateRequest) returns (ClusterStateResponse);
  rpc ClusterAddNode(ClusterAddNodeRequest) returns (ClusterAddNodeResponse);
  rpc ClusterRemoveNode(ClusterRemoveNodeRequest) returns (ClusterRemoveNodeResponse);
  rpc ClusterSplitMetaRange(ClusterSplitMetaRangeRequest) returns (ClusterSplitMetaRangeResponse);
  rpc ClusterMetaRebalance(ClusterMetaRebalanceRequest) returns (ClusterMetaRebalanceResponse);
  rpc RangeSplit(RangeSplitRequest) returns (RangeSplitResponse);
  rpc RangeMerge(RangeMergeRequest) returns (RangeMergeResponse);
  rpc RangeRebalance(RangeRebalanceRequest) returns (RangeRebalanceResponse);
  rpc RangeStats(RangeStatsRequest) returns (RangeStatsResponse);
  rpc RangeSnapshotLatest(RangeSnapshotLatestRequest) returns (RangeSnapshotLatestResponse);
  rpc RangeWriteLatest(RangeWriteLatestRequest) returns (RangeWriteLatestResponse);
  rpc RangeWriteLatestConditional(RangeWriteLatestConditionalRequest) returns (RangeWriteLatestConditionalResponse);
  rpc RangeApplyLatest(RangeApplyLatestRequest) returns (RangeApplyLatestResponse);
  rpc RangeApplyLatestConditional(RangeApplyLatestConditionalRequest) returns (RangeApplyLatestConditionalResponse);
  rpc ClusterFreeze(ClusterFreezeRequest) returns (ClusterFreezeResponse);
  rpc ClusterCheckpointControl(ClusterCheckpointControlRequest) returns (ClusterCheckpointControlResponse);
}

message TxnId {
  uint64 node_id = 1;
  uint64 counter = 2;
}

message Ballot {
  uint64 counter = 1;
  uint64 node_id = 2;
}

message Version {
  uint64 seq = 1;
  TxnId txn_id = 2;
}

message KvGetRequest {
  bytes key = 1;
}

message KvGetResponse {
  bool has_value = 1;
  bytes value = 2;
  Version version = 3;
}

message KvBatchGetRequest {
  repeated bytes keys = 1;
}

message KvBatchGetResponse {
  repeated KvGetResponse responses = 1;
}

enum TxnStatus {
  TXN_STATUS_UNKNOWN = 0;
  TXN_STATUS_PREACCEPTED = 1;
  TXN_STATUS_ACCEPTED = 2;
  TXN_STATUS_COMMITTED = 3;
  TXN_STATUS_EXECUTED = 4;
}

message PreAcceptRequest {
  uint64 group_id = 1;
  TxnId txn_id = 2;
  bytes command = 3;
  uint64 seq = 4;
  repeated TxnId deps = 5;
  Ballot ballot = 6;
}

message PreAcceptResponse {
  bool ok = 1;
  uint64 seq = 2;
  repeated TxnId deps = 3;
  Ballot promised = 4;
}

message PreAcceptBatchRequest {
  repeated PreAcceptRequest requests = 1;
}

message PreAcceptBatchResponse {
  repeated PreAcceptResponse responses = 1;
}

message AcceptRequest {
  uint64 group_id = 1;
  TxnId txn_id = 2;
  bytes command = 3;
  uint64 seq = 4;
  repeated TxnId deps = 5;
  Ballot ballot = 6;
  bytes command_digest = 7;
  bool has_command = 8;
}

message AcceptResponse {
  bool ok = 1;
  Ballot promised = 2;
}

message AcceptBatchRequest {
  repeated AcceptRequest requests = 1;
}

message AcceptBatchResponse {
  repeated AcceptResponse responses = 1;
}

message CommitRequest {
  uint64 group_id = 1;
  TxnId txn_id = 2;
  bytes command = 3;
  uint64 seq = 4;
  repeated TxnId deps = 5;
  Ballot ballot = 6;
  bytes command_digest = 7;
  bool has_command = 8;
}

message CommitResponse {
  bool ok = 1;
}

message CommitBatchRequest {
  repeated CommitRequest requests = 1;
}

message CommitBatchResponse {
  repeated CommitResponse responses = 1;
}

message RecoverRequest {
  uint64 group_id = 1;
  TxnId txn_id = 2;
  Ballot ballot = 3;
}

message RecoverResponse {
  bool ok = 1;
  Ballot promised = 2;
  TxnStatus status = 3;
  Ballot accepted_ballot = 4;
  bytes command = 5;
  uint64 seq = 6;
  repeated TxnId deps = 7;
}

message RecoverBatchRequest {
  repeated RecoverRequest requests = 1;
}

message RecoverBatchResponse {
  repeated RecoverResponse responses = 1;
}

message FetchCommandRequest {
  uint64 group_id = 1;
  TxnId txn_id = 2;
}

message FetchCommandResponse {
  bool has_command = 1;
  bytes command = 2;
}

message ExecutedPrefix {
  uint64 node_id = 1;
  uint64 counter = 2;
}

message ReportExecutedRequest {
  uint64 group_id = 1;
  uint64 from_node_id = 2;
  repeated ExecutedPrefix prefixes = 3;
}

message ReportExecutedResponse {
  bool ok = 1;
}

message LastCommittedRequest {
  uint64 group_id = 1;
  repeated bytes keys = 2;
}

message LastCommittedItem {
  bytes key = 1;
  bool present = 2;
  TxnId txn_id = 3;
  uint64 seq = 4;
}

message LastCommittedResponse {
  repeated LastCommittedItem items = 1;
}

message LastExecutedPrefixRequest {
  uint64 group_id = 1;
}

message LastExecutedPrefixResponse {
  repeated ExecutedPrefix prefixes = 1;
}

message SeedExecutedPrefixRequest {
  uint64 group_id = 1;
  repeated ExecutedPrefix prefixes = 2;
}

message SeedExecutedPrefixResponse {
  bool ok = 1;
}

message ExecutedRequest {
  uint64 group_id = 1;
  TxnId txn_id = 2;
}

message ExecutedResponse {
  bool executed = 1;
}

message MarkVisibleRequest {
  uint64 group_id = 1;
  TxnId txn_id = 2;
}

message MarkVisibleResponse {
  bool ok = 1;
}

message JoinRequest {
  uint64 node_id = 1;
  string grpc_addr = 2;
  string redis_addr = 3;
}

message JoinResponse {
  string initial_members = 1;
}

message ClusterStateRequest {}

message ClusterStateResponse {
  string json = 1;
}

message ClusterAddNodeRequest {
  uint64 node_id = 1;
  string grpc_addr = 2;
  string redis_addr = 3;
}

message ClusterAddNodeResponse {
  bool ok = 1;
}

message ClusterRemoveNodeRequest {
  uint64 node_id = 1;
}

message ClusterRemoveNodeResponse {
  bool ok = 1;
}

message ClusterSplitMetaRangeRequest {
  uint64 split_hash = 1;
  uint64 target_meta_index = 2;
}

message ClusterSplitMetaRangeResponse {
  bool ok = 1;
  uint64 left_meta_index = 2;
  uint64 right_meta_index = 3;
}

message ClusterMetaRebalanceRequest {
  uint64 meta_range_id = 1;
  repeated uint64 replicas = 2;
  uint64 leaseholder = 3;
}

message ClusterMetaRebalanceResponse {
  bool ok = 1;
}

message RangeSplitRequest {
  bytes split_key = 1;
}

message RangeSplitResponse {
  bool ok = 1;
  uint64 left_shard_id = 2;
  uint64 right_shard_id = 3;
}

enum RangeMergeAction {
  RANGE_MERGE_ACTION_START = 0;
  RANGE_MERGE_ACTION_PAUSE = 1;
  RANGE_MERGE_ACTION_RESUME = 2;
  RANGE_MERGE_ACTION_CANCEL = 3;
}

message RangeMergeRequest {
  uint64 left_shard_id = 1;
  RangeMergeAction action = 2;
}

message RangeMergeResponse {
  bool ok = 1;
  uint64 merged_shard_id = 2;
  string message = 3;
}

message RangeRebalanceRequest {
  uint64 shard_id = 1;
  repeated uint64 replicas = 2;
  uint64 leaseholder = 3;
}

message RangeRebalanceResponse {
  bool ok = 1;
}

message RangeStatsRequest {}

message RangeStat {
  uint64 shard_id = 1;
  uint64 shard_index = 2;
  uint64 record_count = 3;
  bool is_leaseholder = 4;
  uint64 write_ops_total = 5;
  uint64 read_ops_total = 6;
  uint64 write_bytes_total = 7;
  uint64 queue_depth = 8;
  double write_tail_latency_ms = 9;
  uint32 hot_key_concentration_bps = 10;
  repeated uint64 write_hot_buckets = 11;
  repeated uint64 read_hot_buckets = 12;
}

message RangeStatsResponse {
  uint64 node_id = 1;
  repeated RangeStat ranges = 2;
}

message RangeSnapshotLatestRequest {
  uint64 shard_index = 1;
  bytes start_key = 2;
  bytes end_key = 3;
  bytes cursor = 4;
  uint32 limit = 5;
  bool reverse = 6;
}

message RangeSnapshotLatestEntry {
  bytes key = 1;
  bytes value = 2;
  Version version = 3;
}

message RangeSnapshotLatestResponse {
  repeated RangeSnapshotLatestEntry entries = 1;
  bytes next_cursor = 2;
  bool done = 3;
}

message RangeWriteLatestEntry {
  bytes key = 1;
  bytes value = 2;
}

message RangeWriteLatestRequest {
  uint64 shard_index = 1;
  bytes start_key = 2;
  bytes end_key = 3;
  repeated RangeWriteLatestEntry entries = 4;
}

message RangeWriteLatestResponse {
  uint64 applied = 1;
}

message RangeWriteLatestConditionalEntry {
  bytes key = 1;
  bytes value = 2;
  Version expected_version = 3;
}

message RangeWriteLatestConditionalAppliedVersion {
  bytes key = 1;
  Version version = 2;
}

message RangeWriteLatestConditionalRequest {
  uint64 shard_index = 1;
  bytes start_key = 2;
  bytes end_key = 3;
  repeated RangeWriteLatestConditionalEntry entries = 4;
}

message RangeWriteLatestConditionalResponse {
  uint64 applied = 1;
  uint64 conflicts = 2;
  repeated RangeWriteLatestConditionalAppliedVersion applied_versions = 3;
}

message RangeApplyLatestRequest {
  uint64 shard_index = 1;
  bytes start_key = 2;
  bytes end_key = 3;
  repeated RangeSnapshotLatestEntry entries = 4;
  bool admin = 5;
}

message RangeApplyLatestResponse {
  uint64 applied = 1;
}

message RangeApplyLatestConditionalEntry {
  bytes key = 1;
  bytes value = 2;
  Version version = 3;
  Version expected_version = 4;
}

message RangeApplyLatestConditionalRequest {
  uint64 shard_index = 1;
  bytes start_key = 2;
  bytes end_key = 3;
  repeated RangeApplyLatestConditionalEntry entries = 4;
  bool admin = 5;
}

message RangeApplyLatestConditionalResponse {
  uint64 applied = 1;
  uint64 conflicts = 2;
}

message ClusterFreezeRequest {
  bool frozen = 1;
}

message ClusterFreezeResponse {
  bool ok = 1;
}

enum ClusterCheckpointAction {
  CLUSTER_CHECKPOINT_ACTION_STATUS = 0;
  CLUSTER_CHECKPOINT_ACTION_PAUSE = 1;
  CLUSTER_CHECKPOINT_ACTION_RESUME = 2;
  CLUSTER_CHECKPOINT_ACTION_TRIGGER = 3;
}

message ClusterCheckpointControlRequest {
  ClusterCheckpointAction action = 1;
}

message ClusterCheckpointControlResponse {
  bool ok = 1;
  string message = 2;
  bool paused = 3;
  uint64 checkpoint_successes = 4;
  uint64 checkpoint_failures = 5;
  uint64 checkpoint_manual_triggers = 6;
  uint64 checkpoint_manual_trigger_failures = 7;
  uint64 checkpoint_pressure_skips = 8;
  uint64 checkpoint_manifest_parse_errors = 9;
  uint64 last_attempt_ms = 10;
  uint64 last_success_ms = 11;
  uint64 max_lag_entries = 12;
  uint64 blocked_groups = 13;
  string last_run_reason = 14;
  uint64 last_free_bytes = 15;
  double last_free_pct = 16;
  string last_error = 17;
}
